<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DDCAS - My Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/"
    }
  }
  </script>
  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: #0b0b0b; }
    body {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      color: #ffffff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #0b0b0b;
      overflow: hidden;
    }
    #brand {
      position: absolute;
      top: 12px;
      left: 16px;
      font-family: 'Arial Black', 'Impact', system-ui, sans-serif;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 2px;
      color: #ffffff;
      text-decoration: none;
      z-index: 5;
    }
    #brand:hover { opacity: 0.85; }
    #back-to-flight {
      position: absolute;
      bottom: 16px;
      left: 16px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.08);
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      z-index: 5;
    }
    #back-to-flight:hover {
      background: rgba(255,255,255,0.16);
    }
    #left-panel {
      position: relative;
    }
    #globe-container {
      width: 100%;
      height: 100%;
    }
    #right-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 72px 24px 24px 16px;
      box-sizing: border-box;
      min-width: 360px;
      height: 100vh;
    }
    .spacer {
      flex: 1 1 0;
    }
    .spacer.top,
    .spacer.bottom {
      flex-grow: 2;
    }
    .panel {
      background: rgba(10, 10, 10, 0.55);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 12px 14px;
      display: grid;
      gap: 10px;
      min-height: 0;
      backdrop-filter: blur(6px);
      flex: 0 0 36vh;
    }
    #log-panel {
      height: 36vh;
      align-content: start;
    }
    #stats-panel {
      height: 36vh;
    }
    .panel-title {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .panel-action {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .panel-action:hover {
      background: rgba(255,255,255,0.12);
    }
    #log-list {
      overflow-y: auto;
      display: grid;
      gap: 8px;
      min-height: 0;
      align-content: start;
    }
    .log-item {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 8px 10px;
      display: grid;
      gap: 4px;
      font-size: 12px;
    }
    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .log-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      padding: 2px 0;
      border-bottom: 1px solid transparent;
    }
    .log-summary:hover {
      border-bottom-color: rgba(255,255,255,0.6);
    }
    .log-details {
      display: none;
      gap: 4px;
    }
    .log-item.expanded .log-details {
      display: grid;
    }
    .log-delete {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .log-delete:hover {
      background: rgba(255,255,255,0.12);
    }
    .log-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      opacity: 0.9;
    }
    .empty-state {
      opacity: 0.7;
      font-size: 12px;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 13px;
    }
    .bar {
      height: 10px;
      border-radius: 6px;
      background: rgba(255,255,255,0.15);
      overflow: hidden;
    }
    .bar .fill {
      height: 100%;
      width: 0%;
      background: #2aa3ff;
      transition: width 0.2s ease;
    }
  </style>
</head>
<body>
  <a id="brand" href="#" data-home>DDCAS</a>
  <button id="back-to-flight" type="button">Back to flight</button>
  <div id="left-panel">
    <div id="globe-container"></div>
  </div>
  <div id="right-panel">
    <div class="spacer top"></div>
    <section id="log-panel" class="panel">
      <div class="panel-header">
        <div class="panel-title">Flight Logs</div>
      </div>
      <div id="crew-code-label" class="stat-row"><span>Crew code</span><span>-</span></div>
      <div id="log-list"></div>
    </section>
    <div class="spacer mid"></div>
    <section id="stats-panel" class="panel">
      <div class="panel-title">Annual total</div>
      <div class="stat-row"><span>Total distance</span><span id="total-distance">0 km</span></div>
      <div class="stat-row"><span>Total dose</span><span id="total-dose">0 uSv</span></div>
      <div class="stat-row"><span>Crew limit (6 mSv)</span><span id="crew-limit-pct">0%</span></div>
      <div class="bar"><div id="crew-limit-fill" class="fill"></div></div>
    </section>
    <div class="spacer bottom"></div>
  </div>

  <script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

  const FLIGHT_RECORDS_KEY = 'ddcas_flight_records';
  const CURRENT_ROLE_KEY = 'ddcas_current_role';
  const CURRENT_USER_KEY = 'ddcas_current_user';
  const CURRENT_CREW_CODE_KEY = 'ddcas_current_crew_code';
  const logList = document.getElementById('log-list');
  const totalDistanceEl = document.getElementById('total-distance');
  const totalDoseEl = document.getElementById('total-dose');
  const crewLimitPctEl = document.getElementById('crew-limit-pct');
  const crewLimitFill = document.getElementById('crew-limit-fill');
  const homeLink = document.querySelector('[data-home]');
  const backToFlight = document.getElementById('back-to-flight');
  const crewCodeLabel = document.getElementById('crew-code-label');

  function getCurrentUser() {
    return localStorage.getItem(CURRENT_USER_KEY) || 'guest';
  }

  function getCurrentCrewCode() {
    return localStorage.getItem(CURRENT_CREW_CODE_KEY) || '';
  }

  const role = localStorage.getItem(CURRENT_ROLE_KEY) || 'crew';
  if (role !== 'crew') {
    window.location.href = './status.html';
  }
  const crewCode = getCurrentCrewCode();
  if (crewCodeLabel) {
    crewCodeLabel.lastElementChild.textContent = crewCode ? crewCode : '-';
  }

  function readLogs() {
    try {
      const raw = localStorage.getItem(FLIGHT_RECORDS_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      const crewCodeValue = getCurrentCrewCode();
      return parsed.filter((entry) => {
        const codes = Array.isArray(entry.crewCodes) ? entry.crewCodes : [];
        if (crewCodeValue && codes.includes(crewCodeValue)) return true;
        const legacyCrew = Array.isArray(entry.crew) ? entry.crew : [];
        return legacyCrew.includes(getCurrentUser());
      });
    } catch (err) {
      console.warn('Failed to read logs', err);
      return [];
    }
  }

  function formatDate(entry) {
    if (entry.dateUTC) {
      const date = new Date(entry.dateUTC);
      if (!Number.isNaN(date.getTime())) {
        return date.toLocaleString();
      }
    }
    return entry.dateDisplay || '-';
  }

  function formatDateOnly(entry) {
    if (entry.dateUTC) {
      const date = new Date(entry.dateUTC);
      if (!Number.isNaN(date.getTime())) {
        return date.toLocaleDateString();
      }
    }
    if (entry.dateDisplay) {
      return entry.dateDisplay.split('T')[0] || entry.dateDisplay;
    }
    return '-';
  }

  let activeRouteId = null;

  function renderLogs(logs) {
    logList.innerHTML = '';
    if (!logs.length) {
      const empty = document.createElement('div');
      empty.className = 'empty-state';
      empty.textContent = 'No logs yet.';
      logList.appendChild(empty);
      return;
    }
    for (const entry of logs) {
      const item = document.createElement('div');
      item.className = 'log-item';
      const header = document.createElement('div');
      header.className = 'log-header';
      const summary = document.createElement('div');
      summary.className = 'log-summary';
      summary.innerHTML = `<span>${entry.depart} â†’ ${entry.arrive}</span><span>${formatDateOnly(entry)}</span>`;
      header.appendChild(summary);
      const details = document.createElement('div');
      details.className = 'log-details';
      const dateRow = document.createElement('div');
      dateRow.className = 'log-row';
      dateRow.innerHTML = `<span>Date</span><span>${formatDate(entry)}</span>`;
      const distRow = document.createElement('div');
      distRow.className = 'log-row';
      distRow.innerHTML = `<span>Distance</span><span>${entry.distanceKm.toFixed(1)} km</span>`;
      const timeRow = document.createElement('div');
      timeRow.className = 'log-row';
      timeRow.innerHTML = `<span>Time</span><span>${entry.hours.toFixed(2)} h</span>`;
      const doseRow = document.createElement('div');
      doseRow.className = 'log-row';
      doseRow.innerHTML = `<span>Dose</span><span>${entry.doseMicroSv.toFixed(2)} uSv</span>`;
      details.appendChild(dateRow);
      details.appendChild(distRow);
      details.appendChild(timeRow);
      details.appendChild(doseRow);
      item.appendChild(header);
      item.appendChild(details);
      logList.appendChild(item);

      summary.addEventListener('click', () => {
        item.classList.toggle('expanded');
        activeRouteId = entry.id;
        showRoute(entry);
      });
    }
  }

  function updateTotals(logs) {
    const totalDistance = logs.reduce((sum, entry) => sum + (entry.distanceKm || 0), 0);
    const totalDose = logs.reduce((sum, entry) => sum + (entry.doseMicroSv || 0), 0);
    const crewLimit = 6000;   // 6 mSv = 6000 uSv
    const crewPct = crewLimit > 0 ? Math.min(100, (totalDose / crewLimit) * 100) : 0;
    totalDistanceEl.textContent = `${totalDistance.toFixed(1)} km`;
    totalDoseEl.textContent = `${totalDose.toFixed(2)} uSv`;
    crewLimitPctEl.textContent = `${crewPct.toFixed(1)}%`;
    crewLimitFill.style.width = `${crewPct}%`;
  }

  function latLonToVector3(lat, lon, radius) {
    const u = (lon + 180) / 360;
    const v = (90 - lat) / 180;
    const theta = v * Math.PI;
    const phi = u * Math.PI * 2;
    const sinTheta = Math.sin(theta);
    const x = -radius * Math.cos(phi) * sinTheta;
    const y =  radius * Math.cos(theta);
    const z =  radius * Math.sin(phi) * sinTheta;
    return new THREE.Vector3(x, y, z);
  }

  function buildArcPoints(lat1, lon1, lat2, lon2, segments = 64) {
    const start = latLonToVector3(lat1, lon1, 1).normalize();
    const end = latLonToVector3(lat2, lon2, 1).normalize();
    const dot = Math.min(1, Math.max(-1, start.dot(end)));
    const omega = Math.acos(dot);
    const sinOmega = Math.sin(omega);
    const points = [];
    for (let i = 0; i <= segments; i++) {
      const t = i / segments;
      let p;
      if (sinOmega < 1e-6) {
        p = start.clone().lerp(end, t).normalize();
      } else {
        const a = Math.sin((1 - t) * omega) / sinOmega;
        const b = Math.sin(t * omega) / sinOmega;
        p = start.clone().multiplyScalar(a).add(end.clone().multiplyScalar(b)).normalize();
      }
      p.multiplyScalar(1.02);
      points.push(p);
    }
    return points;
  }

  function refreshUI() {
    const logs = readLogs().sort((a, b) => {
      const aTime = new Date(a.dateUTC || 0).getTime();
      const bTime = new Date(b.dateUTC || 0).getTime();
      return aTime - bTime;
    });
    renderLogs(logs);
    updateTotals(logs);
    if (activeRouteId) {
      const entry = logs.find((log) => log.id === activeRouteId);
      showRoute(entry);
    } else {
      clearRoutes();
    }
  }


  const logs = readLogs().sort((a, b) => {
    const aTime = new Date(a.dateUTC || 0).getTime();
    const bTime = new Date(b.dateUTC || 0).getTime();
    return aTime - bTime;
  });

  renderLogs(logs);
  updateTotals(logs);

  const container = document.getElementById('globe-container');
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
  camera.position.set(0, 0, 4);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  container.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.enablePan = false;
  controls.enableZoom = false;

  scene.add(new THREE.AmbientLight(0xffffff, 0.4));
  const sunLight = new THREE.DirectionalLight(0xffffff, 0.9);
  sunLight.position.set(5, 3, 5);
  scene.add(sunLight);

  const textureLoader = new THREE.TextureLoader();
  const earthTexture = textureLoader.load('./texture/8k_earth_daymap.jpg');
  earthTexture.colorSpace = THREE.SRGBColorSpace;
  const earth = new THREE.Mesh(
    new THREE.SphereGeometry(1, 64, 64),
    new THREE.MeshBasicMaterial({ map: earthTexture })
  );
  scene.add(earth);

  const routeMaterial = new THREE.LineBasicMaterial({ color: 0x4fc3ff, transparent: true, opacity: 0.95 });
  const markerGeometry = new THREE.SphereGeometry(0.025, 16, 16);
  const startMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff7f });
  const endMaterial = new THREE.MeshBasicMaterial({ color: 0xff5555 });
  let routeGroup = new THREE.Group();
  scene.add(routeGroup);

  function clearRoutes() {
    scene.remove(routeGroup);
    routeGroup.traverse((obj) => {
      if (obj.geometry) obj.geometry.dispose();
      if (obj.material) obj.material.dispose();
    });
    routeGroup = new THREE.Group();
    scene.add(routeGroup);
  }

  function showRoute(entry) {
    if (!entry || typeof entry.srcLat !== 'number') {
      clearRoutes();
      return;
    }
    clearRoutes();
    const points = buildArcPoints(entry.srcLat, entry.srcLon, entry.dstLat, entry.dstLon);
    const geometry = new THREE.BufferGeometry().setFromPoints(points);
    const line = new THREE.Line(geometry, routeMaterial);
    routeGroup.add(line);

    const startMarker = new THREE.Mesh(markerGeometry, startMaterial);
    const endMarker = new THREE.Mesh(markerGeometry, endMaterial);
    startMarker.position.copy(latLonToVector3(entry.srcLat, entry.srcLon, 1.02));
    endMarker.position.copy(latLonToVector3(entry.dstLat, entry.dstLon, 1.02));
    routeGroup.add(startMarker);
    routeGroup.add(endMarker);

    const mid = latLonToVector3(
      (entry.srcLat + entry.dstLat) / 2,
      (entry.srcLon + entry.dstLon) / 2,
      1
    ).normalize();
    const distance = 4;
    camera.position.copy(mid.multiplyScalar(distance));
    camera.up.set(0, 1, 0);
    controls.target.set(0, 0, 0);
    controls.update();
  }

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener('resize', () => {
    const { clientWidth, clientHeight } = container;
    camera.aspect = clientWidth / clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(clientWidth, clientHeight);
  });

  homeLink.addEventListener('click', (event) => {
    event.preventDefault();
    window.location.href = './index.html';
  });
  backToFlight.addEventListener('click', () => {
    window.location.href = './index_hong.html';
  });
  </script>
</body>
</html>
