<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Radiation Exposure Visualization</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/"
    }
  }
  </script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
    }

    canvas { display: block; }

    #time-ui {
      position: absolute;
      top: 16px;
      left: 16px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 12px;
      border-radius: 10px;
      font-family: system-ui, sans-serif;
      z-index: 10;
      backdrop-filter: blur(6px);
    }

    #time-ui button {
      margin-top: 8px;
      width: 100%;
      padding: 6px;
      background: #2aa3ff;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    #legend {
      position: absolute;
      right: 16px;
      bottom: 16px;
      width: 160px;
      padding: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-family: system-ui, sans-serif;
      border-radius: 10px;
      backdrop-filter: blur(6px);
      z-index: 10;
    }

    #legend .title {
      font-size: 12px;
      margin-bottom: 6px;
      opacity: 0.85;
    }

    #legend .bar {
      height: 12px;
      border-radius: 6px;
      background: linear-gradient(
        to right,
        #0040ff,
        #00ffff,
        #ffff00,
        #ff0000
      );
    }

    #legend .labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 4px;
      opacity: 0.8;
    }
  </style>
</head>

<body>

<div id="time-ui">
  <label>Date & Time (UTC)</label><br/>
  <input id="datetimeInput" type="datetime-local" />
  <button id="showBtn">Compute Radiation</button>
</div>

<div id="legend">
  <div class="title">Radiation Exposure (Sv)</div>
  <div class="bar"></div>
  <div class="labels">
    <span>Low</span>
    <span>High</span>
  </div>
</div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

/* =========================
   SCENE / CAMERA / RENDERER
========================= */

const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(
  60, window.innerWidth / window.innerHeight, 0.1, 1000
);
camera.position.set(0, 0, 4);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.outputColorSpace = THREE.SRGBColorSpace;
document.body.appendChild(renderer.domElement);

/* =========================
   CONTROLS
========================= */

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.enablePan = false;
controls.minDistance = 2;
controls.maxDistance = 8;

/* =========================
   LIGHTS & BACKGROUND
========================= */

scene.add(new THREE.AmbientLight(0xffffff, 0.4));

const sunLight = new THREE.DirectionalLight(0xffffff, 1);
scene.add(sunLight);

const loader = new THREE.TextureLoader();
loader.load('./texture/2k_stars.jpg', tex => {
  tex.colorSpace = THREE.SRGBColorSpace;
  scene.background = tex;
});

/* =========================
   EARTH
========================= */

const EARTH_RADIUS = 1;

const earth = new THREE.Mesh(
  new THREE.SphereGeometry(EARTH_RADIUS, 64, 64),
  new THREE.MeshStandardMaterial({
    map: loader.load('./texture/2k_earth_daymap.jpg')
  })
);
scene.add(earth);

/* =========================
   UTILITIES
========================= */

function latLonToVector3(lat, lon, radius) {
  const phi = (90 - lat) * Math.PI / 180;
  const theta = (lon + 180) * Math.PI / 180;
  return new THREE.Vector3(
    -radius * Math.sin(phi) * Math.cos(theta),
     radius * Math.cos(phi),
     radius * Math.sin(phi) * Math.sin(theta)
  );
}

function valueToColor(value, max = 2.0) {
  const t = Math.min(value / max, 1.0);
  return new THREE.Color().setHSL(
    (1 - t) * 0.6, // blue → red
    1.0,
    0.5
  );
}

/* =========================
   MOCK EC2 DATA
========================= */

function generateMockRadiationData(datetime) {
  const grid = [];
  const latStep = 5;
  const lonStep = 5;

  for (let lat = -90; lat <= 90; lat += latStep) {
    for (let lon = -180; lon <= 180; lon += lonStep) {
      let value = Math.random() * 0.2;
      value += Math.exp(-Math.abs(lat) / 20);   // polar enhancement
      if (lon > -30 && lon < 30) value += Math.random() * 0.6; // day-side
      grid.push({ lat, lon, value });
    }
  }

  return {
    meta: {
      datetime,
      lat_step: latStep,
      lon_step: lonStep,
      max_sievert: 2.0
    },
    grid
  };
}

/* =========================
   RADIATION ATMOSPHERIC SHELL
========================= */

let radiationShell = null;

function renderRadiationShell(data) {
  if (radiationShell) {
    scene.remove(radiationShell);
    radiationShell.geometry.dispose();
    radiationShell.material.dispose();
    radiationShell = null;
  }

  const radius = EARTH_RADIUS + 0.03;
  const geometry = new THREE.SphereGeometry(radius, 128, 128);
  const colors = [];

  const lookup = new Map();
  for (const c of data.grid) {
    lookup.set(`${c.lat},${c.lon}`, c.value);
  }

  const latStep = data.meta.lat_step;
  const lonStep = data.meta.lon_step;

  for (let i = 0; i < geometry.attributes.position.count; i++) {
    const v = new THREE.Vector3()
      .fromBufferAttribute(geometry.attributes.position, i)
      .normalize();

    const lat = 90 - Math.acos(v.y) * 180 / Math.PI;
    const lon = Math.atan2(v.z, -v.x) * 180 / Math.PI;

    const latKey = Math.round(lat / latStep) * latStep;
    const lonKey = Math.round(lon / lonStep) * lonStep;

    const value = lookup.get(`${latKey},${lonKey}`) ?? 0;
    const color = valueToColor(value, data.meta.max_sievert);

    colors.push(color.r, color.g, color.b);
  }

  geometry.setAttribute(
    'color',
    new THREE.Float32BufferAttribute(colors, 3)
  );

  const material = new THREE.MeshStandardMaterial({
    vertexColors: true,
    transparent: true,
    opacity: 0.35,
    emissiveIntensity: 0.25,
    side: THREE.DoubleSide,
    depthWrite: false
  });

  radiationShell = new THREE.Mesh(geometry, material);
  scene.add(radiationShell);
}

/* =========================
   UI HOOK
========================= */

const datetimeInput = document.getElementById('datetimeInput');
const showBtn = document.getElementById('showBtn');

showBtn.addEventListener('click', () => {
  if (!datetimeInput.value) {
    alert("날짜와 시간을 선택하세요.");
    return;
  }
  const data = generateMockRadiationData(datetimeInput.value);
  renderRadiationShell(data);
});

/* =========================
   LOOP & RESIZE
========================= */

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
